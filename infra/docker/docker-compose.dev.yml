services:
  backend:
    container_name: backend
    build:
      context: ../../
      dockerfile: ./infra/docker/Dockerfile
    command: pnpm start:dev:watch
    ports:
      - "8000:8000"
      - "9229:9229"
    environment:
      - DATABASE_URL=${DATABASE_URL:-postgresql://postgres:postgres@db:5432/app_dev}
      - METRICS_API_KEY=${METRICS_API_KEY:-}
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - "../../src:/app/src"
      - "../../configs:/app/configs"
      - "../../infra:/app/infra"
      - "../../scripts:/app/scripts"
      - "../../package.json:/app/package.json"
      - "../../tsconfig.json:/app/tsconfig.json"
    networks:
      - starter-network
    labels:
      - "logging=promtail"
      - "logging_jobname=nodejs-app"
    restart: unless-stopped

networks:
  starter-network:
