import type { Cradle } from "@fastify/awilix";
import { partial } from "rambda";

import { ResourceNotFoundException } from "#libs/errors/domain.errors.ts";

import type { {{pascalCase (singular name)}}, {{pascalCase (singular name)}}CreateInput, {{pascalCase (singular name)}}UpdateInput } from "./{{camelCase name}}.contracts.ts";
{{#if withEvents}}
import { {{upperSnakeCase (singular name)}}_EVENTS } from "./{{camelCase name}}.events.ts";
{{/if}}

const create{{pascalCase (singular name)}} = async (
  { {{camelCase name}}Repository{{#if withEvents}}, eventBus{{/if}}, logger }: Cradle,
  input: {{pascalCase (singular name)}}CreateInput,
): Promise<{{pascalCase (singular name)}}> => {
  logger.debug(`[{{pascalCase name}}Mutations] Creating {{singular name}}`);

  const created = (await {{camelCase name}}Repository.createOne(input)) as {{pascalCase (singular name)}};

  {{#if withEvents}}
  await eventBus.emit({{upperSnakeCase (singular name)}}_EVENTS.CREATED, created);
  {{/if}}

  logger.info(`[{{pascalCase name}}Mutations] {{pascalCase (singular name)}} created: ${created.id}`);

  return created;
};

const update{{pascalCase (singular name)}} = async (
  { {{camelCase name}}Repository{{#if withEvents}}, eventBus{{/if}}, logger }: Cradle,
  id: string,
  input: {{pascalCase (singular name)}}UpdateInput,
): Promise<{{pascalCase (singular name)}}> => {
  logger.debug(`[{{pascalCase name}}Mutations] Updating {{singular name}}: ${id}`);

  const updated = await {{camelCase name}}Repository.updateOneById(id, input);
  if (!updated) throw new ResourceNotFoundException(`{{pascalCase (singular name)}} with id: ${id} not found`);

  {{#if withEvents}}
  await eventBus.emit({{upperSnakeCase (singular name)}}_EVENTS.UPDATED, { id: updated.id });
  {{/if}}

  logger.info(`[{{pascalCase name}}Mutations] {{pascalCase (singular name)}} updated: ${updated.id}`);

  return updated;
};

const delete{{pascalCase (singular name)}} = async (
  { {{camelCase name}}Repository{{#if withEvents}}, eventBus{{/if}}, logger }: Cradle,
  id: string,
): Promise<{{pascalCase (singular name)}}> => {
  logger.debug(`[{{pascalCase name}}Mutations] Deleting {{singular name}}: ${id}`);

  const deleted = (await {{camelCase name}}Repository.{{#if softDelete}}softDeleteOneById{{else}}deleteOneById{{/if}}(id)) as undefined | {{pascalCase (singular name)}};
  if (!deleted) throw new ResourceNotFoundException(`{{pascalCase (singular name)}} with id: ${id} not found`);

  {{#if withEvents}}
  await eventBus.emit({{upperSnakeCase (singular name)}}_EVENTS.DELETED, { id: deleted.id });
  {{/if}}

  logger.info(`[{{pascalCase name}}Mutations] {{pascalCase (singular name)}} deleted: ${deleted.id}`);

  return deleted;
};

export default function {{camelCase name}}Mutations(deps: Cradle) {
  return {
    create{{pascalCase (singular name)}}: partial(create{{pascalCase (singular name)}}, [deps]),
    update{{pascalCase (singular name)}}: partial(update{{pascalCase (singular name)}}, [deps]),
    delete{{pascalCase (singular name)}}: partial(delete{{pascalCase (singular name)}}, [deps]),
  };
}
