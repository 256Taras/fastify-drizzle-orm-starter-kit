import type { Cradle } from "@fastify/awilix";
import { partial } from "rambda";

import { ResourceNotFoundException } from "#libs/errors/domain.errors.ts";

import type { {{pascalCase (singular name)}}, {{pascalCase (singular name)}}CreateInput, {{pascalCase (singular name)}}UpdateInput } from "./{{kebabCase name}}.contracts.ts";
{{#if withEvents}}
import { {{upperSnakeCase (singular name)}}_EVENTS } from "./{{kebabCase name}}.events.ts";
{{/if}}

const createOne = async (
  { {{camelCase name}}Repository{{#if withEvents}}, eventBus{{/if}}, logger }: Cradle,
  input: {{pascalCase (singular name)}}CreateInput,
): Promise<{{pascalCase (singular name)}}> => {
  logger.debug(`[{{pascalCase name}}Mutations] Creating {{singular name}}`);

  const created = await {{camelCase name}}Repository.createOne(input);

  {{#if withEvents}}
  await eventBus.emit({{upperSnakeCase (singular name)}}_EVENTS.CREATED, created);
  {{/if}}

  logger.info(`[{{pascalCase name}}Mutations] {{pascalCase (singular name)}} created: ${created.id}`);

  return created;
};

const updateOne = async (
  { {{camelCase name}}Repository{{#if withEvents}}, eventBus{{/if}}, logger }: Cradle,
  id: string,
  input: {{pascalCase (singular name)}}UpdateInput,
): Promise<{{pascalCase (singular name)}}> => {
  logger.debug(`[{{pascalCase name}}Mutations] Updating {{singular name}}: ${id}`);

  const updated = await {{camelCase name}}Repository.updateOneById(id, input);
  if (!updated) throw new ResourceNotFoundException(`{{pascalCase (singular name)}} with id: ${id} not found`);

  {{#if withEvents}}
  await eventBus.emit({{upperSnakeCase (singular name)}}_EVENTS.UPDATED, updated);
  {{/if}}

  logger.info(`[{{pascalCase name}}Mutations] {{pascalCase (singular name)}} updated: ${updated.id}`);

  return updated;
};

const deleteOne = async (
  { {{camelCase name}}Repository{{#if withEvents}}, eventBus{{/if}}, logger }: Cradle,
  id: string,
): Promise<{{pascalCase (singular name)}}> => {
  logger.debug(`[{{pascalCase name}}Mutations] Deleting {{singular name}}: ${id}`);

  const deleted = await {{camelCase name}}Repository.{{#if softDelete}}softDeleteOneById{{else}}deleteOneById{{/if}}(id);
  if (!deleted) throw new ResourceNotFoundException(`{{pascalCase (singular name)}} with id: ${id} not found`);

  {{#if withEvents}}
  await eventBus.emit({{upperSnakeCase (singular name)}}_EVENTS.DELETED, deleted);
  {{/if}}

  logger.info(`[{{pascalCase name}}Mutations] {{pascalCase (singular name)}} deleted: ${deleted.id}`);

  return deleted;
};

export default function {{camelCase name}}Mutations(deps: Cradle) {
  return {
    createOne: partial(createOne, [deps]),
    deleteOne: partial(deleteOne, [deps]),
    updateOne: partial(updateOne, [deps]),
  };
}
